import path from "path";
import fs from "fs-extra";
import yaml from "js-yaml";
import {TextDecoder} from "util";
const yamlPlugin = (options) => ({
  name: "yaml",
  setup(build) {
    build.onResolve({filter: /\.(yml|yaml)$/}, (args) => {
      if (args.resolveDir === "")
        return;
      return {
        path: path.isAbsolute(args.path) ? args.path : path.join(args.resolveDir, args.path),
        namespace: "yaml"
      };
    });
    build.onLoad({filter: /.*/, namespace: "yaml"}, async (args) => {
      const yamlContent = await fs.readFile(args.path);
      let parsed = yaml.load(new TextDecoder().decode(yamlContent), options?.loadOptions);
      if (options?.transform && options.transform(parsed, args.path) !== void 0)
        parsed = options.transform(parsed, args.path);
      return {
        contents: JSON.stringify(parsed),
        loader: "json"
      };
    });
  }
});
export {
  yamlPlugin
};
